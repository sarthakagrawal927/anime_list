name: Update Anime Data

on:
  schedule:
    # Daily at 00:00 UTC (5:30 AM IST)
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Trigger anime data update
        run: |
          response=$(curl -X POST \
            -H "x-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s \
            https://mal-api.onrender.com/api/fetch)

          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS/d')

          echo "Response: $body"

          if [ "$http_status" -ne 200 ]; then
            echo "Error: HTTP $http_status"
            exit 1
          fi

          echo "âœ“ Anime data updated successfully"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Anime data update failed. Check Render logs."
